name: "Terraform + Ansible Azure Deployment"

on:
  workflow_dispatch:
  push:
    paths:
      - 'terraform/**'
      - 'ansible/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # STEP 1 – Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # STEP 2 – Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # STEP 3 – Azure Login (OIDC)
      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          auth-type: IDENTITY

      # STEP 4 – Terraform Init
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      # STEP 5 – Terraform Validate
      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      # STEP 6 – Terraform Plan
      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      # STEP 7 – Terraform Apply
      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"

      # STEP 8 – Extract VM Public IP
      - name: Get Public IP
        working-directory: ./terraform
        id: getip
        run: |
          IP=$(terraform output -raw public_ip)
          echo "VM_IP=$IP" >> $GITHUB_ENV

      # STEP 9 – Update Ansible inventory
      - name: Update Ansible inventory
        run: |
          sed -i "s/CHANGE_ME/${VM_IP}/g" ansible/inventory.ini

      # STEP 10 – Install Ansible
      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      # STEP 11 – Run Ansible Playbook
      - name: Run Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/playbook.y
